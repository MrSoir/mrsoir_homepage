import React, { Component } from 'react';
import { Switch, Route, withRouter } from "react-router-dom";
import logo from './MrSoir_grass.png';
//import logo from './logo.svg';
import './App.css';
import tabs_info from './info.txt';
import TabBar from './TabBar';
import {readTextFile, arraysEqual} from './StaticFunctions';
import MainPage from './main/Main';
import Ballin from './Ballin/Ballin';
import Kubu from './Kubu/Kubu';
import ReferenceManager from './ReferenceManager/ReferenceManager';
import Notes from './Notes/Notes';
import SlideShow from './SlideShow/SlideShow';
import ArduinoFullstack from './ArduinoFullstack/ArduinoFullstack';
import LineAnimation from './LineAnimation/LineAnimation';

class App extends Component {
	constructor(){
		super();
		
		console.log('app-constructor');
		this.state = {
			tabs: []
		}
		
		this.tabClicked = this.tabClicked.bind(this);
		this.genTabSelection = this.genTabSelection.bind(this);
		this.updateTabSelection = this.updateTabSelection.bind(this);
		this.onScroll = this.onScroll.bind(this);
		
		this.header = React.createRef();
		this.body = React.createRef();
		this.logoHeader = React.createRef();
	}
	componentWillMount() {
		window.hist = this.props.history;
		console.log('window.hist: ', window.hist);
		
      let txt = readTextFile(tabs_info);
      
      let tabInfos = txt.split('\n').filter((tn)=>!!tn);
      let tabs = tabInfos.map(ti=>{
      	let [name, path] = ti.split(' | ');
      	return {
      		name,
      		path,
      		selected: false
      	};
      });
      let newstate = this.state;

      newstate.tabs = tabs;

      this.setState(newstate);
      
      this.updateTabSelection();
   }
   componentDidUpdate(prevProps) {
		if (this.props.location !== prevProps.location) {
			this.updateTabSelection();
		}
	}
   updateTabSelection(){
   	let newstate = this.state;
   	let tabs = this.state.tabs;
   	let curRelPath = this.getCurrentRelPath();
   	
   	tabs.forEach(t=>{
   		t.selected = curRelPath.startsWith( t.path );
   	});
   	
   	this.setState(newstate);
   }
   getCurrentRelPath(){
   	return this.props.location.pathname.slice(1);
   }
   genTabSelection(){
   	let tabs = this.state.tabs;
   	
   	let slctn = [];
   	
      let curPath = this.getCurrentRelPath();
      
   	for(let i=0; i < tabnames.length; ++i){
   		slctn.push( curPath.startsWith(tabs[i].path) );
   	}
   	if ( !slctn.some(t=>t) ){
   		slctn[0] = true;
   	}
   	return slctn;
   }
	componentDidMount() {
		window.scrollTo(0, 0);
		window.addEventListener('scroll', this.onScroll);
		this.lastYScroll = 0;
//		window.scrollY = 0;
	}
	
	componentWillUnmount() {
		window.removeEventListener('scroll', this.onScroll);
	}
   tabClicked(id){
   	console.log('tab clicked: ' + id, '   ', this.state.tabs[id].name);
   	let newstate = this.state;
   	let tabs = this.state.tabs;
   	
   	tabs.forEach((t,i)=>t.selected = (id===i));
   	
   	let trmdName = this.state.tabs[id].path;
		this.props.history.push('/' + trmdName);
   	
   	this.setState(newstate);
   }
   onScroll(){
   	let y = window.scrollY;
   	const logohdr = this.logoHeader.current;
   	if (y > 30 && this.lastYScroll <= 30){
   		//logohdr.style.opacity = '0';
   		logohdr.classList.add('Hide');
   		logohdr.classList.remove('Show');
   		this.lastYScroll = y;
   	}else if (y <= 30 && this.lastYScroll > 30){
   		//logohdr.style.opacity = '100';
   		logohdr.classList.add('Show');
   		logohdr.classList.remove('Hide');
   		this.lastYScroll = y;
   	}
   }
	render() {
		return (
			<div className="App">
			
				<LineAnimation />
			
				<div className="App-header" ref={this.header}>
					<TabBar tabs={this.state.tabs} tabCallback={this.tabClicked}/>
					
					<div className="LogoHeader Show" ref={this.logoHeader}>
						<div id="LogoHeaderText" className="MrSoirHeading">Welcome to the World of</div>
						<div id="LogoHeaderImageDiv">
							<img id="LogoHeaderImage" src={logo} alt="logo" />
						</div>
					</div>
					<div id="LogoHeaderSep"></div>
				</div>
				
				<div className="TopMargin">
				</div>
					
				<div className="MainDiv" ref={this.body}>
					<Switch>
						<Route exact path='/' component={MainPage}/>
						<Route exact path='/Main' component={MainPage}/>
						<Route exact path='/ArduinoFullstack' component={ArduinoFullstack}/>
						<Route exact path='/Ballin' component={Ballin}/>
						<Route exact path='/Kubu' component={Kubu}/>
						<Route exact path='/ReferenceManager' component={ReferenceManager}/>
						<Route exact path='/Notes' component={Notes}/>
						<Route exact path='/SlideShow' component={SlideShow}/>
					</Switch>
				</div>
				
				<div className="ContactInfoBox">
					<div className="ContactHeading">CONTACT</div>
					_____
					<br/><br/>
					<div className="ContactText">MrSoir</div>
					<div className="ContactText">support@MrSoir.com</div>
					<div className="ContactText">Tel. +49 157 703 458 32</div>
				</div>
			</div>
		);
	}
}


export default withRouter(App);
